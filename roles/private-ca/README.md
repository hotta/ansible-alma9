# Create Private CA and Server Certificates

This role is just for test and evaluation purpose only.
The auto configuration of web server for maintaining the CA, such as OCSP (Online Certificate Status Protocol) Responder and/or CRL(Certificate Revocatiom List) Distribution Poins, are not supported.

## Prerequisite

First, confirm the default settings involved with certificates. Note that DS389 and Gitlab roles depend on this role/private-ca.

```
$ cd ~/ansible-alma9
$ grep -E '(SUFFIX|FQDN|HOSTNAME2?):' group_vars/all | grep -v PHP
PCA_DOMAIN_SUFFIX:  'example.com'
PCA_HOSTNAME:       "{{ ansible_facts['nodename'] }}"   # primary host name
PCA_HOSTNAME2:      'server2'   # secondary host name to create cert for.
DS389_SUFFIX:       'dc=example,dc=com' # backend-userroot.suffix
DS389_FQDN: "{{ PCA_HOSTNAME }}.{{ PCA_DOMAIN_SUFFIX }}"    # general.full_machine_name
GITLAB_FQDN:        "{{ PCA_HOSTNAME }}.{{ PCA_DOMAIN_SUFFIX }}"
```

Also, you may want to check PCA_* in group_vars/all.

If you change settings described above, do not edit this file directly, instead, do as following:

1. create or modify host_vars/localhost.yml
2. define parameters you want to overwrite in it.

TODO: The automatic configuration for multiple servers.

For example, If you want to "force" create certs for `ldap.example.com` and `gitlab.example.com`, it could be as following:

```
$ cat host_vars/localhost.yml
PCA_HOSTNAME:   'ldap'
PCA_HOSTNAME2:  'gitlab'
PCA_FORCE_CREATE: True
```
## Execution

```
$ ansible-playbook jobs/private-ca.yml
```

If the content of host_vars/localhost.yml is as described above, it will create following directories/files:

- ~/private-ca/root-ca/private/root-ca.key - CA's Root Certificate
- ~/private-ca/sub-ca/private/sub-ca.key - Intermediate Certificate
- ~/private-ca/example.com/ldap.{key,csr,crt} - Server Certificate
- ~/private-ca/example.com/gitlab.{key,csr,crt} - Server Certificate

## Appendix

useful openssl sub commands :

- openssl help 
    - display help
- openssl genrsa -CIPHER [ -out KEYFILE.key ] KEYLEN 
    - create RSA key. See openssl help for -CIPHER
- openssl rsa -in KEYFILE.key -text 
    - display structure of the key file
- openssl rsa -in KEYFILE.key [ -out FILENAME.pub ] -pubout 
    - extract public key only
- openssl req -new -key KEYFILE.key -out FILENAME.csr 
    - create CSR conversationally from scratch using existing key file
- openssl req -new -config CONFIG.conf -out FILENAME.csr -keyout KEYFILE.key
    - create key and csr automatically
- openssl req -in FILENAME.csr -text -noout 
    - Reconfirm CSR
- openssl ca -selfsign -config CONFIG.conf -in FILENAME.csr -out FILENAME.crt -batch -extensions ca_ext
    - Create self-signed cert (for root ca)
- openssl ca -config CONFIG.conf -in FILENAME.csr -out FILENAME.crt -batch -extensions sub_ca_ext
    - Issue sub-ca cert under root-ca

filename extensions:

- .key - private key file
- .csr - CSR(Certificate Signing Request)
- .crt - Certificate file
- .conf - configuration file